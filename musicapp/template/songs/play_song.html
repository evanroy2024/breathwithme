<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ song.title }}</title>
    <style>
        #error-message {
            color: red;
            font-size: 16px;
            margin-top: 20px;
        }
        #vibration-status {
            font-size: 18px;
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <h1>Now Playing: {{ song.title }}</h1>

    <!-- Audio Player -->
    <audio id="audio" controls>
        <source src="{{ song.audio_file.url }}" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <div id="vibration-status">Vibration Pattern: {{ vibration_pattern }}</div>
    <div id="error-message"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const audioElement = document.getElementById('audio');
            const errorMessage = document.getElementById('error-message');
            const vibrationStatus = document.getElementById('vibration-status');

            // Fetch the vibration pattern from Django context
            const vibrationPattern = {{ vibration_pattern|safe }}; // Example: [200, 100, 200, 100]

            // Log the vibration pattern to the console to verify it's correct
            console.log('Vibration Pattern:', vibrationPattern);

            // Function to play vibration in sync with the audio
            function playVibrationSync() {
                if (!('vibrate' in navigator)) {
                    errorMessage.textContent = 'Vibration API is not supported on your device or browser. Please try on a supported device.';
                    console.error('Vibration API not supported.');
                    return;
                }

                if (!Array.isArray(vibrationPattern) || vibrationPattern.length === 0) {
                    errorMessage.textContent = 'No vibration pattern is set for this song. Please contact the admin to configure it.';
                    console.error('No valid vibration pattern found.');
                    return;
                }

                // Start vibration in sync with audio playback
                const durationPerVibration = audioElement.duration / vibrationPattern.length;

                vibrationPattern.forEach((vibrationDuration, index) => {
                    setTimeout(() => {
                        navigator.vibrate(vibrationDuration); // Vibrate for each pattern duration
                        console.log('Vibrating for:', vibrationDuration, 'ms');  // Log each vibration duration
                    }, durationPerVibration * index * 1000); // Sync vibration with audio timing
                });
            }

            // Start vibration when the audio starts
            audioElement.addEventListener('play', playVibrationSync);
        });
    </script>

</body>
</html>
